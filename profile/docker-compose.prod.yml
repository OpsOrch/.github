# OpsOrch Production Stack
# This Docker Compose file sets up a production-ready OpsOrch environment.
# You'll need to configure real provider credentials via environment variables.
#
# Note: OpsOrch Core is a minimal base image. Every organization adds the adapters 
# they need (Jira, Prometheus, PagerDuty, etc.) as plugin binaries. This example 
# shows the volume-mounting approach, but you can also build a custom image with 
# plugins bundled in. See .github/profile/BUILDING_WITH_ADAPTERS.md for details.
#
# Usage:
#   1. curl -O https://raw.githubusercontent.com/OpsOrch/.github/main/profile/docker-compose.prod.yml
#   2. Set up your provider credentials (see environment variables below)
#   3. docker compose -f docker-compose.prod.yml up -d
#   
# Access:
#   - Console UI: http://localhost:3000
#   - Core API: http://localhost:8080
#   - MCP Server: http://localhost:7070/mcp

version: '3.8'

services:
  # OpsOrch Core - The orchestration layer
  # Base image is minimal. Add your adapters in one of two ways:
  #   1. Build a custom image with plugins bundled (recommended for production)
  #   2. Mount plugin binaries via volumes (shown here, flexible for development)
  # 
  # See .github/profile/BUILDING_WITH_ADAPTERS.md or opsorch.com/docs/building-with-adapters
  # for complete examples with Jira, Prometheus, PagerDuty, Elasticsearch, etc.
  opsorch-core:
    # Option 1: Use base image and mount plugins (development/testing)
    image: ghcr.io/opsorch/opsorch-core:latest
    # Option 2: Use your custom-built image with plugins bundled
    # image: your-registry/opsorch-core:v1.0.0
    container_name: opsorch-core-prod
    ports:
      - "8080:8080"
    environment:
      # Core configuration
      - OPSORCH_BEARER_TOKEN=${OPSORCH_BEARER_TOKEN:-your-secure-token-here}
      - OPSORCH_LOG_LEVEL=info
      - OPSORCH_PORT=8080
      
      # Provider configuration - customize based on your tool stack
      # Each capability (incident, ticket, metric, log, etc.) can use a different adapter
      
      # Incident Management (choose one: PagerDuty, Datadog, etc.)
      - OPSORCH_INCIDENT_PLUGIN=/opt/opsorch/plugins/incidentplugin
      - OPSORCH_INCIDENT_CONFIG=${OPSORCH_INCIDENT_CONFIG:-{}}
      
      # Ticketing (choose one: Jira, GitHub Issues, etc.)
      - OPSORCH_TICKET_PLUGIN=/opt/opsorch/plugins/ticketplugin
      - OPSORCH_TICKET_CONFIG=${OPSORCH_TICKET_CONFIG:-{}}
      
      # Metrics (choose one: Prometheus, Datadog, etc.)
      - OPSORCH_METRIC_PLUGIN=/opt/opsorch/plugins/metricplugin
      - OPSORCH_METRIC_CONFIG=${OPSORCH_METRIC_CONFIG:-{}}
      
      # Logs (choose one: Elasticsearch, Datadog, etc.)
      - OPSORCH_LOG_PLUGIN=/opt/opsorch/plugins/logplugin
      - OPSORCH_LOG_CONFIG=${OPSORCH_LOG_CONFIG:-{}}
      
      # Messaging (optional: Slack, etc.)
      - OPSORCH_MESSAGING_PLUGIN=/opt/opsorch/plugins/messagingplugin
      - OPSORCH_MESSAGING_CONFIG=${OPSORCH_MESSAGING_CONFIG:-{}}
      
      # Services (optional: PagerDuty, Datadog, etc.)
      - OPSORCH_SERVICE_PLUGIN=/opt/opsorch/plugins/serviceplugin
      - OPSORCH_SERVICE_CONFIG=${OPSORCH_SERVICE_CONFIG:-{}}
    volumes:
      # Mount directory containing your adapter plugin binaries
      # Download from: https://github.com/OpsOrch/opsorch-{adapter}-adapter/releases
      - ./plugins:/opt/opsorch/plugins:ro
      # Optional: Mount custom configuration
      - ./config:/opt/opsorch/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - opsorch-prod

  # OpsOrch MCP Server
  opsorch-mcp:
    image: ghcr.io/opsorch/opsorch-mcp:latest
    container_name: opsorch-mcp-prod
    ports:
      - "7070:7070"
    environment:
      - OPSORCH_CORE_URL=http://opsorch-core:8080
      - OPSORCH_CORE_TOKEN=${OPSORCH_BEARER_TOKEN:-your-secure-token-here}
      - OPSORCH_CORE_TIMEOUT_MS=30000
      - MCP_HTTP_PORT=7070
      - OPSORCH_LOG_LEVEL=info
      - MCP_HTTP_ALLOW_ORIGINS=${CONSOLE_URL:-http://localhost:3000}
      - MCP_HTTP_ALLOW_HOSTS=${CONSOLE_HOST:-localhost}
    depends_on:
      opsorch-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7070/mcp", "-H", "Content-Type: application/json", "-d", "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"tools/list\"}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - opsorch-prod

  # OpsOrch Console (OSS Edition)
  opsorch-console:
    image: ghcr.io/opsorch/opsorch-console:latest-oss
    container_name: opsorch-console-prod
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_OPSORCH_CORE_URL=${CORE_URL:-http://localhost:8080}
      - NEXT_PUBLIC_OPSORCH_EDITION=oss
      # Optional: Add Copilot URL when available
      # - NEXT_PUBLIC_COPILOT_URL=${COPILOT_URL:-http://localhost:6060}
    depends_on:
      opsorch-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - opsorch-prod

networks:
  opsorch-prod:
    driver: bridge
    name: opsorch-prod-network

# Example .env file configuration:
# OPSORCH_BEARER_TOKEN=your-secure-random-token
# 
# # Incident Configuration (PagerDuty incident plugin)
# OPSORCH_INCIDENT_CONFIG={"apiToken":"your-pd-token","serviceID":"PXXXXXX","fromEmail":"pagerduty-user@example.com","apiURL":"https://api.pagerduty.com"}
# 
# # Ticket Configuration  (Jira ticket plugin)
# OPSORCH_TICKET_CONFIG={"apiToken":"your-jira-token","email":"your-email","apiURL":"https://your-domain.atlassian.net","projectKey":"OPS"}
# 
# # Metric Configuration (Prometheus metric plugin)
# OPSORCH_METRIC_CONFIG={"url":"http://your-prometheus:9090"}
# 
# # Log Configuration (Elasticsearch log plugin)
# OPSORCH_LOG_CONFIG={"addresses":["http://your-elasticsearch:9200"],"username":"elastic","password":"your-password","indexPattern":"logs-*"}
# 
# # Messaging Configuration (Slack messaging plugin)
# OPSORCH_MESSAGING_CONFIG={"token":"xoxb-your-slack-bot-token"}
# 
# # Service Configuration (PagerDuty service plugin)
# OPSORCH_SERVICE_CONFIG={"apiToken":"your-pd-token","apiURL":"https://api.pagerduty.com"}
# 
# # Console Configuration
# CORE_URL=http://localhost:8080
# CONSOLE_URL=http://localhost:3000
# CONSOLE_HOST=localhost
